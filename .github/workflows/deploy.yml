name: CD - Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - stage
          - preprod
          - prod

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linting
        run: npm run lint
      
      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  amp-deployment-check:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Amp SDK
        run: npm install @sourcegraph/amp-sdk
      
      - name: Pre-deployment analysis with Amp
        env:
          AMP_API_KEY: ${{ secrets.AMP_API_KEY }}
        run: |
          cat << 'EOF' > deployment-check.mjs
          import { execute } from '@sourcegraph/amp-sdk';
          
          const prompt = `
          Perform a pre-deployment check for this Next.js application:
          
          1. Review the Dockerfile for best practices
          2. Check if there are any environment variables that need to be set
          3. Verify the build configuration in next.config.js
          4. Look for any potential deployment issues
          
          Provide a brief deployment readiness report.
          `;
          
          for await (const message of execute({
            prompt,
            options: {
              dangerouslyAllowAll: true,
              cwd: process.cwd()
            }
          })) {
            if (message.type === 'result') {
              console.log(message.is_error ? `Error: ${message.error}` : message.result);
            }
          }
          EOF
          
          node deployment-check.mjs || true

  notify-deployment:
    runs-on: ubuntu-latest
    needs: [build-and-push, amp-deployment-check]
    if: success()
    
    steps:
      - name: Deployment notification
        run: |
          echo "âœ… Deployment successful!"
          echo "Image: ${{ needs.build-and-push.outputs.image-tag }}"
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
